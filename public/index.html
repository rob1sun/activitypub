<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min ActivityPub Läsare</title>
    <style>
        :root { --bg: #f0f2f5; --card: #fff; --blue: #1877f2; --green: #42b72a; --text: #1c1e21; --gray: #65676b; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 800px; margin: 0 auto; }
        
        /* Navigation */
        .nav { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .nav-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 5px 0; font-weight: 600; color: var(--gray); position: relative; }
        .nav-btn.active { color: var(--blue); }
        .nav-btn.active::after { content:''; display:block; width:100%; height:3px; background:var(--blue); position:absolute; bottom:-12px; }

        /* Input Area */
        .input-area { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; font-size: 1rem; border: 1px solid #ddd; border-radius: 6px; }
        .btn { padding: 0 24px; color: white; border: none; cursor: pointer; border-radius: 6px; font-size: 1rem; font-weight: 600; transition: opacity 0.2s; }
        .btn-primary { background: var(--blue); }
        .btn-success { background: var(--green); }
        .btn:hover { opacity: 0.9; }
        .mode-toggle { display: block; margin-top: 10px; font-size: 0.85rem; color: var(--blue); cursor: pointer; text-decoration: underline; }

        /* Search Results Grid */
        .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); margin-bottom: 20px; }
        .user-card { background: var(--card); border: 1px solid #ddd; padding: 12px; border-radius: 8px; display: flex; gap: 12px; align-items: center; }
        .user-card img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-handle { font-size: 0.8rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .card-actions { display: flex; gap: 5px; flex-direction: column; justify-content: center; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; font-weight: 600; }
        .btn-view { background: #e4e6eb; color: black; }
        .btn-follow { background: var(--blue); color: white; }
        .btn-follow.following { background: #dafbe1; color: green; border: 1px solid green; pointer-events: none; }

        /* Profile & Posts */
        .profile-header { background: var(--card); padding: 20px; border-radius: 8px; display: flex; gap: 20px; align-items: center; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .profile-header img { width: 80px; height: 80px; border-radius: 50%; }
        .post { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .post-meta { font-size: 0.85rem; color: var(--gray); margin-bottom: 10px; }
        .post-content img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; }

        .hidden { display: none; }
        .loading { text-align: center; padding: 20px; color: var(--gray); font-style: italic; }
        .error { color: #d32f2f; background: #fde8e8; padding: 10px; border-radius: 6px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <nav class="nav">
        <button class="nav-btn active" onclick="switchTab('search')">Sök & Upptäck</button>
        <button class="nav-btn" onclick="loadMyFeed()">Mitt Flöde</button>
    </nav>

    <div id="tab-search">
        <div class="input-area">
            <div class="input-group">
                <input type="text" id="main-input" placeholder="Sök efter namn (t.ex. Greta, Linux)...">
                <button id="action-btn" class="btn btn-primary" onclick="handleAction()">Sök</button>
            </div>
            <a class="mode-toggle" onclick="toggleSearchMode()" id="mode-text">Har du en exakt adress? Klicka här.</a>
        </div>

        <div id="error-msg" class="error hidden"></div>
        
        <div id="search-results" class="grid hidden"></div>

        <div id="profile-view" class="hidden">
            <div id="profile-header" class="profile-header"></div>
            <h3>Inlägg</h3>
            <div id="profile-posts"></div>
        </div>
    </div>

    <div id="tab-feed" class="hidden">
        <div id="feed-status" class="loading"></div>
        <div id="feed-container"></div>
    </div>

    <script>
        // --- State ---
        let isSearchMode = true; // true = Sök, false = Exakt adress
        let currentActor = null;
        let myFollows = []; // Cache för vilka vi följer

        // --- Init ---
        // Ladda följare direkt så vi vet vem som ska ha grön knapp
        fetch('/api/following').then(r => r.json()).then(data => myFollows = data).catch(() => {});

        // --- UI Logic ---

        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('tab-search').classList.add('hidden');
            document.getElementById('tab-feed').classList.add('hidden');
            
            if (tab === 'search') document.getElementById('tab-search').classList.remove('hidden');
            if (tab === 'feed') document.getElementById('tab-feed').classList.remove('hidden');
        }

        function toggleSearchMode() {
            isSearchMode = !isSearchMode;
            const input = document.getElementById('main-input');
            const btn = document.getElementById('action-btn');
            const text = document.getElementById('mode-text');
            const results = document.getElementById('search-results');
            
            // Rensa UI
            results.innerHTML = '';
            results.classList.add('hidden');
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('error-msg').classList.add('hidden');

            if (isSearchMode) {
                input.placeholder = "Sök efter namn (t.ex. Greta, Linux)...";
                btn.innerText = "Sök";
                text.innerText = "Har du en exakt adress? Klicka här.";
            } else {
                input.placeholder = "Ange adress (t.ex. gargron@mastodon.social)...";
                btn.innerText = "Hämta";
                text.innerText = "Vill du söka på namn? Klicka här.";
            }
        }

        function handleAction() {
            if (isSearchMode) performSearch();
            else performDirectLookup();
        }

        // --- 1. SÖK FUNKTION ---
        async function performSearch() {
            const query = document.getElementById('main-input').value.trim();
            const grid = document.getElementById('search-results');
            const errorDiv = document.getElementById('error-msg');
            
            if (!query) return;

            grid.innerHTML = '<div class="loading">Söker i Fediversum...</div>';
            grid.classList.remove('hidden');
            document.getElementById('profile-view').classList.add('hidden');
            errorDiv.classList.add('hidden');

            try {
                // Sök via mastodon.social proxy
                const searchUrl = `https://mastodon.social/api/v2/search?q=${encodeURIComponent(query)}&type=accounts&limit=8`;
                const data = await proxyFetch(searchUrl);

                if (!data.accounts || data.accounts.length === 0) {
                    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center">Inga träffar hittades.</div>';
                    return;
                }

                let html = '';
                // Uppdatera vår cache av följare för säkerhets skull
                try { myFollows = await (await fetch('/api/following')).json(); } catch(e){}

                data.accounts.forEach(user => {
                    // Normalisera handle
                    let handle = user.acct;
                    if (!handle.includes('@')) handle += '@mastodon.social';

                    // Kolla om vi redan följer (jämför URL eller handle)
                    const isFollowing = myFollows.some(u => u.url === user.url || u.handle === handle);

                    html += `
                        <div class="user-card">
                            <img src="${user.avatar}" alt="${user.username}">
                            <div class="user-info">
                                <div class="user-name">${user.display_name || user.username}</div>
                                <div class="user-handle">@${handle}</div>
                            </div>
                            <div class="card-actions">
                                <button class="btn-sm btn-view" onclick="viewUser('${handle}')">Visa</button>
                                ${isFollowing 
                                    ? `<button class="btn-sm btn-follow following">Följer</button>`
                                    : `<button class="btn-sm btn-follow" id="btn-${user.id}" onclick="quickFollow('${user.url}', '${handle}', '${user.avatar}', '${user.display_name}', '${user.id}')">Följ</button>`
                                }
                            </div>
                        </div>
                    `;
                });
                grid.innerHTML = html;

            } catch (err) {
                errorDiv.innerText = "Sökning misslyckades: " + err.message;
                errorDiv.classList.remove('hidden');
                grid.innerHTML = '';
            }
        }

        // --- 2. VISA ANVÄNDARE (View) ---
        async function viewUser(handle) {
            // Rensa search grid om vi är i "Hämta"-läge, men behåll om vi kom från sök
            if (!isSearchMode) document.getElementById('search-results').classList.add('hidden');
            
            const profileView = document.getElementById('profile-view');
            const profileHeader = document.getElementById('profile-header');
            const profilePosts = document.getElementById('profile-posts');
            const errorDiv = document.getElementById('error-msg');

            profileView.classList.remove('hidden');
            profileHeader.innerHTML = '<div class="loading">Laddar profil...</div>';
            profilePosts.innerHTML = '';
            errorDiv.classList.add('hidden');

            try {
                // 1. Resolve handle till URL
                const profileUrl = await resolveHandle(handle);
                
                // 2. Hämta Actor JSON
                currentActor = await proxyFetch(profileUrl);
                
                // 3. Rendera Header
                await renderProfileHeader(currentActor, handle);

                // 4. Hämta Outbox
                if (currentActor.outbox) {
                    profilePosts.innerHTML = '<div class="loading">Hämtar inlägg...</div>';
                    await loadOutbox(currentActor.outbox, 'profile-posts');
                    if(profilePosts.innerText.includes('Hämtar inlägg')) profilePosts.innerHTML = 'Inga publika inlägg.';
                } else {
                    profilePosts.innerHTML = 'Ingen publik outbox.';
                }

            } catch (err) {
                errorDiv.innerText = "Kunde inte ladda profil: " + err.message;
                errorDiv.classList.remove('hidden');
                profileView.classList.add('hidden');
            }
        }

        async function renderProfileHeader(actor, handle) {
            // Uppdatera följ-status
            try { myFollows = await (await fetch('/api/following')).json(); } catch(e){}
            const isFollowing = myFollows.some(u => u.url === (actor.id || actor.url));
            
            const name = actor.name || actor.preferredUsername || 'Namnlös';
            const icon = actor.icon?.url || '';
            const summary = actor.summary || '';
            const url = actor.id || actor.url;

            const html = `
                <img src="${icon}">
                <div style="flex:1">
                    <h2>${name}</h2>
                    <div style="color:#666;font-size:0.9rem;">${handle}</div>
                    <div style="margin-top:5px;font-size:0.9rem;">${summary}</div>
                </div>
                <button class="btn btn-primary ${isFollowing ? 'btn-success' : ''}" 
                    onclick="toggleFollowFromProfile('${url}', '${handle}', '${icon}', '${name}')">
                    ${isFollowing ? 'Följer' : 'Följ'}
                </button>
            `;
            document.getElementById('profile-header').innerHTML = html;
        }

        // --- 3. DIREKT HÄMTNING ---
        async function performDirectLookup() {
            const input = document.getElementById('main-input').value.trim();
            if (!input) return;
            viewUser(input);
        }

        // --- 4. FÖLJA LOGIK ---

        // Alternativ A: Följ från söklistan (Quick Follow)
        async function quickFollow(url, handle, icon, name, btnId) {
            const btn = document.getElementById(`btn-${btnId}`);
            btn.innerText = "...";
            
            try {
                await fetch('/api/following', {
                    method: 'POST',
                    body: JSON.stringify({ url, handle, icon, name })
                });
                
                // Uppdatera UI
                btn.innerText = "Följer";
                btn.classList.add('following');
                btn.classList.remove('btn-follow');
                
                // Uppdatera cache
                myFollows.push({ url, handle });
            } catch (e) {
                alert("Kunde inte följa: " + e.message);
                btn.innerText = "Följ";
            }
        }

        // Alternativ B: Följ inifrån profilen (Toggle)
        async function toggleFollowFromProfile(url, handle, icon, name) {
            const isFollowing = myFollows.some(u => u.url === url);
            const method = isFollowing ? 'DELETE' : 'POST';
            
            await fetch('/api/following', {
                method: method,
                body: JSON.stringify({ url, handle, icon, name })
            });

            // Ladda om headern
            renderProfileHeader(currentActor, handle);
        }

        // --- HJÄLPFUNKTIONER ---

        async function proxyFetch(url) {
            const res = await fetch(`/api/lookup?target=${encodeURIComponent(url)}`);
            if (!res.ok) {
                const json = await res.json().catch(()=>{});
                throw new Error(json?.error || `HTTP ${res.status}`);
            }
            return await res.json();
        }

        async function resolveHandle(handle) {
            if (handle.startsWith('http')) return handle;
            
            // Städa och säkerställ user@domain
            let clean = handle.trim().replace(/^@/, '');
            if (!clean.includes('@')) throw new Error("Ange formatet user@domain.com");
            
            const [u, d] = clean.split('@');
            const webfinger = `https://${d}/.well-known/webfinger?resource=acct:${clean}`;
            
            const data = await proxyFetch(webfinger);
            const link = data.links.find(l => l.type && l.type.includes('activity+json'));
            
            if (!link) throw new Error("Ingen ActivityPub-profil hittades för denna adress.");
            return link.href;
        }

        async function loadOutbox(url, containerId) {
            const container = document.getElementById(containerId);
            
            let data = await proxyFetch(url);
            if (data.first) data = await proxyFetch(typeof data.first === 'string' ? data.first : data.first.id);
            
            const items = data.orderedItems || data.items || [];
            
            let html = '';
            items.forEach(item => {
                const post = item.type === 'Create' ? item.object : item;
                if (!post.content) return;
                
                let media = '';
                if(post.attachment) {
                    post.attachment.forEach(att => {
                        if(att.mediaType?.startsWith('image')) media += `<img src="${att.url}">`;
                    });
                }

                html += `
                    <div class="post">
                        <div class="post-meta">
                            <strong>${item.author || ''}</strong> • ${new Date(post.published).toLocaleString()}
                        </div>
                        <div class="post-content">${post.content} ${media}</div>
                        <a href="${post.url}" target="_blank" style="font-size:0.8rem;color:#666">Länk</a>
                    </div>
                `;
            });
            
            if (html) container.innerHTML = html;
        }

        // --- FLÖDE ---
        async function loadMyFeed() {
            switchTab('feed');
            const container = document.getElementById('feed-container');
            const status = document.getElementById('feed-status');
            container.innerHTML = '';
            status.innerText = "Laddar flöde...";
            status.classList.remove('hidden');

            try {
                const follows = await (await fetch('/api/following')).json();
                if (follows.length === 0) {
                    status.innerHTML = "Du följer ingen än. <a href='#' onclick='switchTab(\"search\")'>Gå till sök!</a>";
                    return;
                }

                const promises = follows.map(async (user) => {
                    try {
                        // Optimering: Om vi sparade outbox-url i KV skulle vi slippa detta anrop
                        const actor = await proxyFetch(user.url);
                        if (actor.outbox) {
                            let data = await proxyFetch(actor.outbox);
                            if (data.first) data = await proxyFetch(typeof data.first === 'string' ? data.first : data.first.id);
                            return (data.orderedItems || []).map(i => ({...i, author: user.name}));
                        }
                    } catch(e) {}
                    return [];
                });

                const results = await Promise.all(promises);
                const allPosts = results.flat().sort((a,b) => new Date((b.object||b).published) - new Date((a.object||a).published));
                
                status.classList.add('hidden');
                
                let html = '';
                allPosts.forEach(item => {
                    const post = item.type === 'Create' ? item.object : item;
                    if(!post.content) return;
                    let media = '';
                    if(post.attachment) post.attachment.forEach(att => { if(att.mediaType?.startsWith('image')) media += `<img src="${att.url}">`; });

                    html += `
                    <div class="post">
                        <div class="post-meta"><strong>${item.author}</strong> • ${new Date(post.published).toLocaleString()}</div>
                        <div class="post-content">${post.content} ${media}</div>
                    </div>`;
                });
                container.innerHTML = html;

            } catch(e) { status.innerText = "Fel: " + e.message; }
        }
    </script>
</body>
</html>
