<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min ActivityPub L칛sare</title>
    <style>
        :root { --bg: #f0f2f5; --card: #fff; --blue: #1877f2; --grey: #6c757d; --text: #1c1e21; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 800px; margin: 0 auto; }
        
        /* Navigation */
        .nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .nav-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 5px 15px; font-weight: bold; color: #666; }
        .nav-btn.active { color: var(--blue); border-bottom: 3px solid var(--blue); }

        /* S칬kbox */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; background: var(--card); padding: 15px; border-radius: 8px; }
        input { flex: 1; padding: 10px; font-size: 1rem; }
        .btn { padding: 10px 20px; background: var(--blue); color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 1rem; }
        .btn-search { background: var(--grey); }
        .btn:hover { opacity: 0.9; }
        
        /* Resultat Grid (f칬r s칬kning) */
        .search-results { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); margin-bottom: 20px; }
        .user-preview { background: var(--card); border: 1px solid #ddd; padding: 10px; border-radius: 8px; display: flex; gap: 10px; align-items: center; }
        
        /* Profil & Inl칛gg */
        .card { background: var(--card); border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .profile-header { display: flex; gap: 15px; align-items: center; }
        .profile-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        
        .follow-btn { margin-left: auto; background: #e4e6eb; color: black; font-size: 0.9rem; }
        .follow-btn.following { background: #dafbe1; color: green; border: 1px solid green; }
        
        .post-meta { font-size: 0.8rem; color: #666; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .hidden { display: none; }
        .loading { text-align: center; color: #666; font-style: italic; margin: 20px 0; }
        .error { color: red; background: #ffebe8; padding: 10px; border-radius: 5px; }

        /* Bilder i inl칛gg */
        .post-content img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="nav">
        <button class="nav-btn active" onclick="showTab('search')">游댌 S칬k & Uppt칛ck</button>
        <button class="nav-btn" onclick="loadMyFeed()">游닗 Mitt Fl칬de</button>
    </div>

    <div id="tab-search">
        <div class="search-box">
            <input type="text" id="ap-input" placeholder="Namn (t.ex. Greta) eller adress..." />
            <button class="btn" onclick="startLookup()">H칛mta</button>
            <button class="btn btn-search" onclick="searchUsers()">S칬k</button>
        </div>
        
        <div id="search-results-container" class="search-results"></div>
        <div id="profile-container"></div>
        <div id="posts-container"></div>
    </div>

    <div id="tab-feed" class="hidden">
        <div id="feed-status" class="loading">Laddar ditt fl칬de...</div>
        <div id="feed-container"></div>
    </div>

    <script>
        // --- ActivityPub Helpers ---
        async function proxyFetch(url) {
            const res = await fetch(`/api/lookup?target=${encodeURIComponent(url)}`);
            if (!res.ok) throw new Error("Kunde inte h칛mta data");
            return await res.json();
        }

        async function resolveHandle(handle) {
            if (handle.startsWith('http')) return handle;
            let h = handle.trim().replace('@', ''); // St칛da input
            const [u, d] = h.split('@');
            if (!d) throw new Error("Ange fullst칛ndig adress (user@domain.com) f칬r direkt h칛mtning.");
            
            const data = await proxyFetch(`https://${d}/.well-known/webfinger?resource=acct:${h}`);
            const link = data.links.find(l => l.type && l.type.includes('activity+json'));
            if (!link) throw new Error("Ingen ActivityPub-profil hittades.");
            return link.href;
        }

        // --- Global state ---
        let currentActor = null; 

        // --- 1. S칐K (via Mastodon API) ---
        async function searchUsers() {
            const input = document.getElementById('ap-input').value.trim();
            const resultsDiv = document.getElementById('search-results-container');
            const profileDiv = document.getElementById('profile-container');
            const postsDiv = document.getElementById('posts-container');

            if (!input) return alert("Skriv n친got att s칬ka p친!");

            // Rensa tidigare vyer
            profileDiv.innerHTML = '';
            postsDiv.innerHTML = '';
            resultsDiv.innerHTML = '<div class="loading">S칬ker...</div>';

            try {
                // Vi anv칛nder mastodon.social f칬r att s칬ka
                const searchUrl = `https://mastodon.social/api/v2/search?q=${encodeURIComponent(input)}&type=accounts&limit=6`;
                const data = await proxyFetch(searchUrl);
                
                if (!data.accounts || data.accounts.length === 0) {
                    resultsDiv.innerHTML = '<div style="grid-column: 1/-1; text-align:center;">Inga tr칛ffar. Prova "H칛mta" om du har exakt adress.</div>';
                    return;
                }

                let html = '';
                data.accounts.forEach(user => {
                    // Fixa handle om den saknar dom칛n
                    let handle = user.acct;
                    if (!handle.includes('@')) handle += '@mastodon.social';

                    html += `
                        <div class="user-preview">
                            <img src="${user.avatar}" style="width:40px;height:40px;border-radius:50%">
                            <div style="overflow:hidden; flex:1">
                                <div style="font-weight:bold; font-size:0.9rem;">${user.display_name || user.username}</div>
                                <div style="font-size:0.75rem; color:#666;">@${handle}</div>
                            </div>
                            <button class="btn" style="padding:5px 10px; font-size:0.8rem;" onclick="selectUser('${handle}')">V칛lj</button>
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;

            } catch (e) {
                resultsDiv.innerHTML = `<div class="error">S칬kfel: ${e.message}</div>`;
            }
        }

        function selectUser(handle) {
            document.getElementById('ap-input').value = handle;
            document.getElementById('search-results-container').innerHTML = ''; // G칬m s칬kresultat
            startLookup(); // K칬r den "riktiga" h칛mtningen
        }

        // --- 2. H츿MTA PROFIL (ActivityPub) ---
        async function startLookup() {
            const input = document.getElementById('ap-input').value;
            const profileDiv = document.getElementById('profile-container');
            const postsDiv = document.getElementById('posts-container');
            
            if (!input) return;
            
            // Rensa
            document.getElementById('search-results-container').innerHTML = '';
            profileDiv.innerHTML = '';
            postsDiv.innerHTML = '<div class="loading">Laddar profil...</div>';

            try {
                const url = await resolveHandle(input);
                currentActor = await proxyFetch(url); // Spara globalt
                await renderProfile(currentActor);

                if (currentActor.outbox) {
                    postsDiv.innerHTML = '<div class="loading">Laddar inl칛gg...</div>';
                    await loadOutbox(currentActor.outbox, 'posts-container');
                    // Ta bort laddnings-texten om det gick bra, annars ligger inl칛ggen d칛r
                    if(postsDiv.innerHTML.includes('Laddar inl칛gg')) postsDiv.innerHTML = ''; 
                } else {
                    postsDiv.innerHTML = 'Ingen publik outbox.';
                }
            } catch (e) { 
                profileDiv.innerHTML = `<div class="error">${e.message}</div>`;
                postsDiv.innerHTML = '';
            }
        }

        async function renderProfile(actor) {
            const isFollowing = await checkFollowing(actor.id || actor.url);
            
            const html = `
                <div class="card profile-header">
                    <img src="${actor.icon?.url || ''}" class="profile-img">
                    <div style="flex:1">
                        <h3>${actor.name || actor.preferredUsername || 'Namnl칬s'}</h3>
                        <small>${actor.summary || ''}</small>
                    </div>
                    <button class="btn follow-btn ${isFollowing ? 'following' : ''}" 
                            onclick="toggleFollow('${actor.id || actor.url}', '${actor.name || actor.preferredUsername}', '${actor.icon?.url || ''}')">
                        ${isFollowing ? 'F칬ljer' : 'F칬lj'}
                    </button>
                </div>
            `;
            document.getElementById('profile-container').innerHTML = html;
        }

        // --- 3. INL츿GG LOGIK ---
        async function loadOutbox(url, containerId) {
            let data = await proxyFetch(url);
            if (data.first) data = await proxyFetch(typeof data.first === 'string' ? data.first : data.first.id);
            
            const items = data.orderedItems || data.items || [];
            if (containerId) renderPosts(items, containerId);
            return items;
        }

        function renderPosts(items, containerId) {
            const container = document.getElementById(containerId);
            // Om beh친llaren 칛r tom (f칬rutom laddtext), rensa den
            if(container.innerText.includes('Laddar')) container.innerHTML = '';

            let html = '';
            items.forEach(item => {
                const post = item.type === 'Create' ? item.object : item;
                if (!post.content) return;
                
                // Hantera bilder
                let mediaHtml = '';
                if (post.attachment && Array.isArray(post.attachment)) {
                    post.attachment.forEach(att => {
                        if (att.mediaType?.startsWith('image') && att.url) {
                            mediaHtml += `<img src="${att.url}" loading="lazy" />`;
                        }
                    });
                }

                html += `
                    <div class="card">
                        <div class="post-meta">
                            <strong>${item.author || ''}</strong> 
                            ${new Date(post.published).toLocaleString()}
                        </div>
                        <div class="post-content">
                            ${post.content}
                            ${mediaHtml}
                        </div>
                         <a href="${post.url}" target="_blank" style="font-size:0.8rem; color:#666;">Original</a>
                    </div>`;
            });
            container.innerHTML += html;
        }

        // --- 4. KV & F칬lj-Logik ---
        async function checkFollowing(url) {
            try {
                const res = await fetch('/api/following');
                const list = await res.json();
                return list.some(u => u.url === url);
            } catch(e) { return false; }
        }

        async function toggleFollow(url, name, icon) {
            const isFollowing = await checkFollowing(url);
            const method = isFollowing ? 'DELETE' : 'POST';
            
            // Vi sparar en "handle" ocks친 f칬r snygghetens skull
            const handle = document.getElementById('ap-input').value || name;

            await fetch('/api/following', {
                method: method,
                body: JSON.stringify({ url, name, icon, handle })
            });
            
            // Uppdatera knappen direkt
            renderProfile(currentActor);
        }

        // --- 5. Mitt Fl칬de ---
        async function loadMyFeed() {
            showTab('feed');
            const container = document.getElementById('feed-container');
            const status = document.getElementById('feed-status');
            
            container.innerHTML = '';
            status.classList.remove('hidden');
            status.innerText = "H칛mtar listan p친 de du f칬ljer...";

            try {
                const res = await fetch('/api/following');
                const following = await res.json();

                if (following.length === 0) {
                    status.innerText = "Du f칬ljer ingen 칛n. S칬k upp n친gon!";
                    return;
                }

                status.innerText = `H칛mtar inl칛gg fr친n ${following.length} personer...`;

                // H칛mta allt parallellt
                let allPosts = [];
                const promises = following.map(async (user) => {
                    try {
                        // H칛mta profil f칬r att hitta outbox
                        const actor = await proxyFetch(user.url);
                        if (actor.outbox) {
                            let items = await loadOutbox(actor.outbox, null); // null = rita inte ut 칛n
                            // L칛gg till f칬rfattare p친 objektet s친 vi kan visa det i fl칬det
                            return items.map(i => ({...i, author: user.name || user.handle})); 
                        }
                    } catch (e) { console.error("Fel vid h칛mtning av", user.name); }
                    return [];
                });

                const results = await Promise.all(promises);
                allPosts = results.flat();

                // Sortera
                allPosts.sort((a, b) => {
                    const tA = new Date((a.object || a).published).getTime();
                    const tB = new Date((b.object || b).published).getTime();
                    return tB - tA;
                });

                status.classList.add('hidden');
                renderPosts(allPosts, 'feed-container');

            } catch (err) {
                status.innerText = "Fel: " + err.message;
            }
        }

        // --- UI ---
        function showTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
            
            document.getElementById('tab-' + tab).classList.remove('hidden');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
