<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActivityPub Läsare</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1c1e21;
            --secondary-text: #65676b;
            --accent-color: #1877f2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 700px;
        }

        /* Input Section */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover { background-color: #166fe5; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Profile Card */
        .profile-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .profile-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #eee;
        }

        .profile-info h2 { margin: 0 0 5px 0; font-size: 1.2rem; }
        .profile-summary { font-size: 0.95rem; color: var(--text-color); margin-top: 10px; }

        /* Timeline / Posts */
        .timeline-header { margin: 20px 0 10px; font-weight: bold; color: var(--secondary-text); }
        
        .post {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .post-meta {
            font-size: 0.85rem;
            color: var(--secondary-text);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .post-content { line-height: 1.5; overflow-wrap: break-word; }
        .post-content p { margin-top: 0; }
        .post-content img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 10px; }
        .post-link { text-decoration: none; color: var(--secondary-text); }
        .post-link:hover { text-decoration: underline; }

        .error { background: #ffebe8; color: #cc0000; padding: 10px; border-radius: 6px; margin-bottom: 20px; }
        .loading { text-align: center; color: var(--secondary-text); padding: 20px; font-style: italic; }
        .hidden { display: none; }

    </style>
</head>
<body>

    <div class="container">
        <h1>ActivityPub Läsare</h1>
        
    <div class="search-box">
        <input type="text" id="ap-input" placeholder="Namn eller adress..." />
        <button id="fetch-btn" onclick="startLookup()">Hämta</button>
        <button id="search-btn" onclick="searchUsers()" style="background-color: #6c757d; margin-left: 5px;">Sök</button>
    </div>

        <div id="error-msg" class="error hidden"></div>

        <div id="profile-container"></div>
        
        <div id="timeline-title" class="timeline-header hidden">Tidslinje</div>
        <div id="posts-container"></div>
    </div>

    <script>
        const API_ENDPOINT = '/api/lookup';

        // Lyssna på Enter-tangenten i inputfältet
        document.getElementById('ap-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') startLookup();
        });

        // Huvudfunktion
        async function startLookup() {
            const input = document.getElementById('ap-input').value.trim();
            const profileDiv = document.getElementById('profile-container');
            const postsDiv = document.getElementById('posts-container');
            const errorDiv = document.getElementById('error-msg');
            const titleDiv = document.getElementById('timeline-title');
            const btn = document.getElementById('search-btn');

            if (!input) return;

            // Återställ UI
            profileDiv.innerHTML = '';
            postsDiv.innerHTML = '<div class="loading">Laddar...</div>';
            errorDiv.classList.add('hidden');
            titleDiv.classList.add('hidden');
            btn.disabled = true;

            try {
                // 1. WebFinger / URL hantering
                const profileUrl = await resolveHandle(input);
                console.log("Hittad URL:", profileUrl);

                // 2. Hämta Profil (Actor)
                const actor = await proxyFetch(profileUrl);
                renderProfile(actor);

                // 3. Hämta Outbox (Inlägg)
                if (actor.outbox) {
                    titleDiv.classList.remove('hidden');
                    await loadOutbox(actor.outbox);
                } else {
                    postsDiv.innerHTML = '<div class="loading">Ingen outbox hittades.</div>';
                }

            } catch (error) {
                console.error(error);
                errorDiv.textContent = `Fel: ${error.message}`;
                errorDiv.classList.remove('hidden');
                postsDiv.innerHTML = '';
            } finally {
                btn.disabled = false;
            }
        }

        // --- Hjälpfunktioner ---

        async function proxyFetch(targetUrl) {
            const response = await fetch(`${API_ENDPOINT}?target=${encodeURIComponent(targetUrl)}`);
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error || `HTTP ${response.status}`);
            }
            return await response.json();
        }

        async function resolveHandle(handle) {
            let cleanHandle = handle;
            if (cleanHandle.startsWith('@')) cleanHandle = cleanHandle.substring(1);

            // Om det redan är en URL
            if (cleanHandle.startsWith('http')) return cleanHandle;

            // Validera format user@domain
            const parts = cleanHandle.split('@');
            if (parts.length !== 2) throw new Error("Formatet ska vara user@domain.com eller en URL.");

            const [user, domain] = parts;
            const webfingerUrl = `https://${domain}/.well-known/webfinger?resource=acct:${cleanHandle}`;
            
            const data = await proxyFetch(webfingerUrl);
            
            const link = data.links.find(l => 
                l.rel === 'self' && 
                (l.type.includes('activity+json') || l.type.includes('ld+json'))
            );

            if (!link || !link.href) throw new Error("Kunde inte hitta profil via WebFinger.");
            
            return link.href;
        }

        function renderProfile(data) {
            const container = document.getElementById('profile-container');
            const iconUrl = data.icon?.url || ''; 
            const name = data.name || data.preferredUsername || 'Okänd';
            const summary = data.summary || 'Ingen beskrivning.';

            container.innerHTML = `
                <div class="profile-card">
                    ${iconUrl ? `<img src="${iconUrl}" class="profile-img" alt="${name}">` : ''}
                    <div class="profile-info">
                        <h2>${name}</h2>
                        <div class="profile-summary">${summary}</div>
                    </div>
                </div>
            `;
        }

        async function loadOutbox(outboxUrl) {
            const container = document.getElementById('posts-container');
            
            // Hämta outbox-roten
            let collection = await proxyFetch(outboxUrl);

            // Navigera till första sidan om den finns
            if (collection.first) {
                const nextUrl = typeof collection.first === 'string' ? collection.first : collection.first.id;
                collection = await proxyFetch(nextUrl);
            }

            const items = collection.orderedItems || collection.items || [];
            
            if (items.length === 0) {
                container.innerHTML = '<div class="loading">Inga inlägg hittades.</div>';
                return;
            }

            let html = '';
            items.forEach(item => {
                // Hantera både "Create"-aktiviteter och råa objekt
                const postObject = item.type === 'Create' ? item.object : item;
                
                // Vi vill helst bara visa Note (inlägg) eller Article
                if (!postObject.content) return;

                const date = new Date(postObject.published).toLocaleString();
                const link = postObject.url || item.id || '#';

                // Hantera bilder i inlägg (Attachment)
                let mediaHtml = '';
                if (postObject.attachment && Array.isArray(postObject.attachment)) {
                    postObject.attachment.forEach(att => {
                        if (att.mediaType && att.mediaType.startsWith('image') && att.url) {
                            mediaHtml += `<img src="${att.url}" loading="lazy" />`;
                        }
                    });
                }

                html += `
                    <div class="post">
                        <div class="post-meta">
                            <span>${date}</span>
                            <a href="${link}" target="_blank" class="post-link">Original</a>
                        </div>
                        <div class="post-content">
                            ${postObject.content}
                            ${mediaHtml}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        async function discoverUsers() {
    const container = document.getElementById('profile-container');
    const postsDiv = document.getElementById('posts-container');
    const titleDiv = document.getElementById('timeline-title');
    
    // Rensa tidigare resultat
    postsDiv.innerHTML = '';
    titleDiv.classList.add('hidden');
    container.innerHTML = '<div class="loading">Hämtar katalogen från mastodon.social...</div>';

    try {
        // Vi lånar katalogen från en stor instans (mastodon.social)
        // order=new visar de nyaste användarna, eller order=active för de mest aktiva
        const directoryUrl = 'https://mastodon.social/api/v1/directory?order=active&limit=10';
        
        // Använd din befintliga proxy!
        const users = await proxyFetch(directoryUrl);

        if (!Array.isArray(users)) {
            throw new Error("Kunde inte hämta katalogen.");
        }

        let html = '<h2>Upptäck profiler</h2><div style="display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">';

        users.forEach(user => {
            // Mastodons API returnerar 'acct' (handle) och 'url'
            const handle = user.acct.includes('@') ? user.acct : `${user.acct}@mastodon.social`;
            
            html += `
                <div style="border:1px solid #ddd; padding:10px; border-radius:8px; text-align:center;">
                    <img src="${user.avatar}" style="width:50px;height:50px;border-radius:50%;margin-bottom:5px;">
                    <div style="font-weight:bold;">${user.display_name || user.username}</div>
                    <div style="font-size:0.8rem; color:#666; overflow:hidden; text-overflow:ellipsis;">@${handle}</div>
                    <button onclick="document.getElementById('ap-input').value='${handle}'; startLookup();" style="margin-top:5px; font-size:0.8rem; padding:5px 10px;">Visa</button>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;

    } catch (error) {
        container.innerHTML = `<p class="error">Kunde inte ladda katalogen: ${error.message}</p>`;
    }
}
async function searchUsers() {
    const input = document.getElementById('ap-input').value.trim();
    const container = document.getElementById('profile-container');
    const postsDiv = document.getElementById('posts-container');
    const titleDiv = document.getElementById('timeline-title');

    if (!input) {
        alert("Skriv in ett namn att söka efter!");
        return;
    }

    // Rensa tidigare innehåll
    postsDiv.innerHTML = '';
    titleDiv.classList.add('hidden');
    container.innerHTML = '<div class="loading">Söker i Fediversum...</div>';

    try {
        // Vi använder mastodon.socials sök-API.
        // type=accounts säger att vi bara vill ha användare, inte inlägg.
        const searchUrl = `https://mastodon.social/api/v2/search?q=${encodeURIComponent(input)}&type=accounts&limit=5`;
        
        // Hämta via vår proxy
        const data = await proxyFetch(searchUrl);
        
        // Svaret ligger i data.accounts
        const accounts = data.accounts || [];

        if (accounts.length === 0) {
            container.innerHTML = '<div class="error">Inga användare hittades.</div>';
            return;
        }

        let html = '<h2>Sökresultat</h2><div style="display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">';

        accounts.forEach(user => {
            // Om användaren är på en annan server ser 'acct' ut som 'user@domain'.
            // Om de är på samma server (mastodon.social) ser den ut som 'user'. Vi måste fixa det.
            let handle = user.acct;
            if (!handle.includes('@')) {
                handle = `${handle}@mastodon.social`;
            }

            html += `
                <div style="border:1px solid #ddd; padding:15px; border-radius:8px; display:flex; gap:10px; align-items:center; background:white;">
                    <img src="${user.avatar}" style="width:50px;height:50px;border-radius:50%; object-fit:cover;">
                    <div style="overflow:hidden;">
                        <div style="font-weight:bold;">${user.display_name || user.username}</div>
                        <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">@${handle}</div>
                        
                        <button onclick="selectUser('${handle}')" style="padding:5px 10px; font-size:0.8rem;">Välj</button>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;

    } catch (error) {
        console.error(error);
        container.innerHTML = `<p class="error">Sökning misslyckades: ${error.message}</p>`;
    }
}

// Hjälpfunktion för att välja en användare från listan
function selectUser(handle) {
    document.getElementById('ap-input').value = handle;
    // Kör den vanliga hämtningen direkt
    startLookup();
}
    </script>
</body>
</html>



