<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActivityPub L√§sare</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1c1e21;
            --secondary-text: #65676b;
            --accent-color: #1877f2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 700px;
        }

        /* Input Section */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover { background-color: #166fe5; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Profile Card */
        .profile-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .profile-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #eee;
        }

        .profile-info h2 { margin: 0 0 5px 0; font-size: 1.2rem; }
        .profile-summary { font-size: 0.95rem; color: var(--text-color); margin-top: 10px; }

        /* Timeline / Posts */
        .timeline-header { margin: 20px 0 10px; font-weight: bold; color: var(--secondary-text); }
        
        .post {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .post-meta {
            font-size: 0.85rem;
            color: var(--secondary-text);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .post-content { line-height: 1.5; overflow-wrap: break-word; }
        .post-content p { margin-top: 0; }
        .post-content img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 10px; }
        .post-link { text-decoration: none; color: var(--secondary-text); }
        .post-link:hover { text-decoration: underline; }

        .error { background: #ffebe8; color: #cc0000; padding: 10px; border-radius: 6px; margin-bottom: 20px; }
        .loading { text-align: center; color: var(--secondary-text); padding: 20px; font-style: italic; }
        .hidden { display: none; }

    </style>
</head>
<body>

    <div class="container">
        <h1>ActivityPub L√§sare</h1>
        
        <div class="search-box">
            <input type="text" id="ap-input" placeholder="Anv√§ndare@dom√§n (t.ex. Gargron@mastodon.social)" />
            <button id="search-btn" onclick="startLookup()">H√§mta</button>
            <button onclick="discoverUsers()">üé≤ Hitta slumpm√§ssiga profiler</button>
        </div>

        <div id="error-msg" class="error hidden"></div>

        <div id="profile-container"></div>
        
        <div id="timeline-title" class="timeline-header hidden">Tidslinje</div>
        <div id="posts-container"></div>
    </div>

    <script>
        const API_ENDPOINT = '/api/lookup';

        // Lyssna p√• Enter-tangenten i inputf√§ltet
        document.getElementById('ap-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') startLookup();
        });

        // Huvudfunktion
        async function startLookup() {
            const input = document.getElementById('ap-input').value.trim();
            const profileDiv = document.getElementById('profile-container');
            const postsDiv = document.getElementById('posts-container');
            const errorDiv = document.getElementById('error-msg');
            const titleDiv = document.getElementById('timeline-title');
            const btn = document.getElementById('search-btn');

            if (!input) return;

            // √Öterst√§ll UI
            profileDiv.innerHTML = '';
            postsDiv.innerHTML = '<div class="loading">Laddar...</div>';
            errorDiv.classList.add('hidden');
            titleDiv.classList.add('hidden');
            btn.disabled = true;

            try {
                // 1. WebFinger / URL hantering
                const profileUrl = await resolveHandle(input);
                console.log("Hittad URL:", profileUrl);

                // 2. H√§mta Profil (Actor)
                const actor = await proxyFetch(profileUrl);
                renderProfile(actor);

                // 3. H√§mta Outbox (Inl√§gg)
                if (actor.outbox) {
                    titleDiv.classList.remove('hidden');
                    await loadOutbox(actor.outbox);
                } else {
                    postsDiv.innerHTML = '<div class="loading">Ingen outbox hittades.</div>';
                }

            } catch (error) {
                console.error(error);
                errorDiv.textContent = `Fel: ${error.message}`;
                errorDiv.classList.remove('hidden');
                postsDiv.innerHTML = '';
            } finally {
                btn.disabled = false;
            }
        }

        // --- Hj√§lpfunktioner ---

        async function proxyFetch(targetUrl) {
            const response = await fetch(`${API_ENDPOINT}?target=${encodeURIComponent(targetUrl)}`);
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error || `HTTP ${response.status}`);
            }
            return await response.json();
        }

        async function resolveHandle(handle) {
            let cleanHandle = handle;
            if (cleanHandle.startsWith('@')) cleanHandle = cleanHandle.substring(1);

            // Om det redan √§r en URL
            if (cleanHandle.startsWith('http')) return cleanHandle;

            // Validera format user@domain
            const parts = cleanHandle.split('@');
            if (parts.length !== 2) throw new Error("Formatet ska vara user@domain.com eller en URL.");

            const [user, domain] = parts;
            const webfingerUrl = `https://${domain}/.well-known/webfinger?resource=acct:${cleanHandle}`;
            
            const data = await proxyFetch(webfingerUrl);
            
            const link = data.links.find(l => 
                l.rel === 'self' && 
                (l.type.includes('activity+json') || l.type.includes('ld+json'))
            );

            if (!link || !link.href) throw new Error("Kunde inte hitta profil via WebFinger.");
            
            return link.href;
        }

        function renderProfile(data) {
            const container = document.getElementById('profile-container');
            const iconUrl = data.icon?.url || ''; 
            const name = data.name || data.preferredUsername || 'Ok√§nd';
            const summary = data.summary || 'Ingen beskrivning.';

            container.innerHTML = `
                <div class="profile-card">
                    ${iconUrl ? `<img src="${iconUrl}" class="profile-img" alt="${name}">` : ''}
                    <div class="profile-info">
                        <h2>${name}</h2>
                        <div class="profile-summary">${summary}</div>
                    </div>
                </div>
            `;
        }

        async function loadOutbox(outboxUrl) {
            const container = document.getElementById('posts-container');
            
            // H√§mta outbox-roten
            let collection = await proxyFetch(outboxUrl);

            // Navigera till f√∂rsta sidan om den finns
            if (collection.first) {
                const nextUrl = typeof collection.first === 'string' ? collection.first : collection.first.id;
                collection = await proxyFetch(nextUrl);
            }

            const items = collection.orderedItems || collection.items || [];
            
            if (items.length === 0) {
                container.innerHTML = '<div class="loading">Inga inl√§gg hittades.</div>';
                return;
            }

            let html = '';
            items.forEach(item => {
                // Hantera b√•de "Create"-aktiviteter och r√•a objekt
                const postObject = item.type === 'Create' ? item.object : item;
                
                // Vi vill helst bara visa Note (inl√§gg) eller Article
                if (!postObject.content) return;

                const date = new Date(postObject.published).toLocaleString();
                const link = postObject.url || item.id || '#';

                // Hantera bilder i inl√§gg (Attachment)
                let mediaHtml = '';
                if (postObject.attachment && Array.isArray(postObject.attachment)) {
                    postObject.attachment.forEach(att => {
                        if (att.mediaType && att.mediaType.startsWith('image') && att.url) {
                            mediaHtml += `<img src="${att.url}" loading="lazy" />`;
                        }
                    });
                }

                html += `
                    <div class="post">
                        <div class="post-meta">
                            <span>${date}</span>
                            <a href="${link}" target="_blank" class="post-link">Original</a>
                        </div>
                        <div class="post-content">
                            ${postObject.content}
                            ${mediaHtml}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    </script>
</body>
</html>

